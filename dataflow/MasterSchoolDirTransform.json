{
	"name": "MasterSchoolDirTransform",
	"properties": {
		"folder": {
			"name": "MasterSchoolDir"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"linkedService": {
						"referenceName": "AzureSynapseAnalytics1",
						"type": "LinkedServiceReference"
					},
					"name": "CharterSchoolDirectory"
				},
				{
					"linkedService": {
						"referenceName": "AzureSynapseAnalytics1",
						"type": "LinkedServiceReference"
					},
					"name": "WASchoolDirectory"
				}
			],
			"sinks": [
				{
					"linkedService": {
						"referenceName": "AzureSynapseAnalytics1",
						"type": "LinkedServiceReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [
				{
					"name": "SelectCharterColumn",
					"description": "Remove columns: phone number, CSP and school leader name."
				},
				{
					"name": "SelectWAColumns",
					"description": "Remove columns: Email, PrincipalName and Phone"
				},
				{
					"name": "join1"
				},
				{
					"name": "derivedColumn1"
				},
				{
					"name": "select1"
				},
				{
					"name": "Leadingzero"
				},
				{
					"name": "derivedColumn2"
				}
			],
			"scriptLines": [
				"source(output(",
				"          {School Code} as string,",
				"          {School Name} as string,",
				"          {Local District Code} as string,",
				"          {Local District} as string,",
				"          {School Leader Name} as string,",
				"          {Charter School CCDDD Code} as string,",
				"          {Phone Number} as string,",
				"          Address as string,",
				"          {Address 2} as string,",
				"          Region as string,",
				"          CSP as string,",
				"          {Lowest Grade} as string,",
				"          {Highest Grade} as string,",
				"          {Grades Served at Scale} as string,",
				"          {Grades Served (E,M,H)} as string,",
				"          Authorizer as string,",
				"          {Date Authorized} as string,",
				"          {Date Opened} as string,",
				"          {Authorized Seats} as string,",
				"          Status as string,",
				"          {Organizational level} as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     format: 'table',",
				"     store: 'synapseanalytics',",
				"     schemaName: 'staging',",
				"     tableName: 'CharterSchoolDirectory',",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     staged: true) ~> CharterSchoolDirectory",
				"source(output(",
				"          {School Code} as string,",
				"          {School Name} as string,",
				"          {District Code} as string,",
				"          {District Name} as string,",
				"          Region as string,",
				"          {Lowest Grade} as string,",
				"          {Highest Grade} as string,",
				"          {Grades Served at Scale} as string,",
				"          {Grades Served (E,M,H)} as string,",
				"          Authorizer as string,",
				"          {Date Authorized} as string,",
				"          {Date Opened} as string,",
				"          {Authorized Seats} as string,",
				"          Status as string,",
				"          {Organizational level} as string,",
				"          {ESD Code} as string,",
				"          {ESD Name} as string,",
				"          City as string,",
				"          State as string,",
				"          ZipCode as string,",
				"          {Org Category List} as string,",
				"          {AYP Code} as string,",
				"          {Grade Category} as string,",
				"          Address as string,",
				"          {Address 2} as string,",
				"          {Charter School?} as boolean,",
				"          Latitude as double,",
				"          Longitude as double,",
				"          County as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     format: 'table',",
				"     store: 'synapseanalytics',",
				"     schemaName: 'staging',",
				"     tableName: 'MasterSchoolDirectoryGeo',",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     staged: true) ~> WASchoolDirectory",
				"CharterSchoolDirectory select(mapColumn(",
				"          {School Code},",
				"          {School Name},",
				"          {Local District Code},",
				"          {Local District},",
				"          Address,",
				"          {Address 2},",
				"          Region,",
				"          {Lowest Grade},",
				"          {Highest Grade},",
				"          {Grades Served at Scale},",
				"          {Grades Served (E,M,H)},",
				"          Authorizer,",
				"          {Date Authorized},",
				"          {Date Opened},",
				"          {Authorized Seats},",
				"          Status,",
				"          {Organizational level}",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> SelectCharterColumn",
				"WASchoolDirectory select(mapColumn(",
				"          {School Code},",
				"          {School Name},",
				"          {District Code},",
				"          {District Name},",
				"          Region,",
				"          {Lowest Grade},",
				"          {Highest Grade},",
				"          {Grades Served at Scale},",
				"          {Grades Served (E,M,H)},",
				"          Authorizer,",
				"          {Date Authorized},",
				"          {Date Opened},",
				"          {Authorized Seats},",
				"          Status,",
				"          {Organizational level},",
				"          {ESD Code},",
				"          {ESD Name},",
				"          City,",
				"          State,",
				"          ZipCode,",
				"          {Org Category List},",
				"          {AYP Code},",
				"          {Grade Category},",
				"          Address,",
				"          {Address 2},",
				"          {Charter School?},",
				"          Latitude,",
				"          Longitude,",
				"          County",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> SelectWAColumns",
				"SelectCharterColumn, Leadingzero join(SelectCharterColumn@{School Code} == SelectWAColumns@{School Code},",
				"     joinType:'right',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> join1",
				"join1 derive({Address New} = case(isNull(SelectCharterColumn@Address), SelectWAColumns@Address, SelectCharterColumn@Address),",
				"          {Address 2 New} = case(isNull(SelectCharterColumn@{Address 2}), SelectWAColumns@{Address 2}, SelectCharterColumn@{Address 2}),",
				"          {District Code New} = case(isNull({Local District Code}), {District Code}, {Local District Code}),",
				"          {District Name New} = case(isNull({Local District}), {District Name}, {Local District}),",
				"          {Organization Level New} = case(isNull(SelectCharterColumn@{Organizational level}), 'Public School', SelectCharterColumn@{Organizational level}),",
				"          {Charter School? New} = case(isNull(SelectCharterColumn@{Organizational level}), 'No', 'Yes'),",
				"          {Highest Grade New} = case(isNull(SelectCharterColumn@{Highest Grade}),SelectWAColumns@{Highest Grade}, SelectCharterColumn@{Highest Grade}),",
				"          {Lowest Grade New} = case(isNull(SelectCharterColumn@{Lowest Grade}),SelectWAColumns@{Lowest Grade}, SelectCharterColumn@{Lowest Grade})) ~> derivedColumn1",
				"derivedColumn2 select(mapColumn(",
				"          {School Code} = SelectWAColumns@{School Code},",
				"          {School Name} = SelectWAColumns@{School Name},",
				"          {District Code} = {District Code New},",
				"          {District Name} = {District Name New},",
				"          {Charter Region} = SelectCharterColumn@Region,",
				"          {Charter Lowest Grade} = SelectCharterColumn@{Lowest Grade},",
				"          {Charter Highest Grade} = SelectCharterColumn@{Highest Grade},",
				"          {Charter Grades Served at Scale} = SelectCharterColumn@{Grades Served at Scale},",
				"          {Charter Grades Served (E,M,H)} = SelectCharterColumn@{Grades Served (E,M,H)},",
				"          {Charter Authorizer} = SelectCharterColumn@Authorizer,",
				"          {Charter Date Authorized} = SelectCharterColumn@{Date Authorized},",
				"          {Charter Date Opened} = SelectCharterColumn@{Date Opened},",
				"          {Charter Authorized Seats} = SelectCharterColumn@{Authorized Seats},",
				"          {Charter Status} = SelectCharterColumn@Status,",
				"          {Organizational level} = {Organization Level New},",
				"          {ESD Code},",
				"          {ESD Name},",
				"          City,",
				"          State,",
				"          ZipCode,",
				"          {Org Category List},",
				"          {AYP Code},",
				"          {Grade Category},",
				"          Address,",
				"          {Address 2},",
				"          {Organization Level} = {Organization Level New},",
				"          {Charter School?} = {Charter School? New},",
				"          Latitude,",
				"          Longitude,",
				"          County",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select1",
				"SelectWAColumns derive({LEA Code 1} = case(length({District Code})<5, '0'+{District Code}, {District Code})) ~> Leadingzero",
				"derivedColumn1 derive(Address = replace(translate({Address New}, '\"!@#$%^&*()_+-=[]|\\\\:;<>,.?/~`', '$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$'), '$', ''),",
				"          {Address 2} = replace(translate({Address 2 New}, '\"!@#$%^&*()_+-=[]|\\\\:;<>,.?/~`', '$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$'), '$', '')) ~> derivedColumn2",
				"select1 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     format: 'table',",
				"     store: 'synapseanalytics',",
				"     schemaName: 'transform',",
				"     tableName: 'MasterSchoolDirectory',",
				"     insertable: true,",
				"     updateable: false,",
				"     deletable: false,",
				"     upsertable: false,",
				"     recreate: true,",
				"     allowCopyCommand: true,",
				"     staged: true,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     partitionBy('hash', 1),",
				"     preCommands: [],",
				"     postCommands: []) ~> sink1"
			]
		}
	}
}