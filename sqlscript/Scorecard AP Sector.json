{
	"name": "Scorecard AP Sector",
	"properties": {
		"content": {
			"query": "SET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE PROC [scorecard].[sp_AcademicPerformanceSector_MOD] AS\nBEGIN\n    SET NOCOUNT ON;\n\n    ------------------------------------------------------------\n    -- Safe drop if table exists\n    ------------------------------------------------------------\n    IF OBJECT_ID('scorecard.AcademicPerformanceSector', 'U') IS NOT NULL\n    BEGIN\n        DROP TABLE scorecard.AcademicPerformanceSector;\n    END;\n\n    ------------------------------------------------------------\n    -- CTAS with HEAP to avoid columnstore issues\n    ------------------------------------------------------------\n    CREATE TABLE scorecard.AcademicPerformanceSector\n    WITH\n    (\n        DISTRIBUTION = ROUND_ROBIN,\n        HEAP\n    )\n    AS\n    WITH cte_district AS (\n        SELECT DISTINCT \n              [SchoolYear]\n            , 'District' AS [OrganizationLevel]\n            , [StudentGroupType]\n            , [StudentGroupCategory]\n            , [StudentGroup]\n            , [GradeLevel]\n            , [TestAdministration]\n            , [TestSubject]\n            , [CountMetStandard District]\n            , [CountofStudentsExpectedtoTest(including previously passed) District]\n            , [PercentMet District]\n       FROM [scorecard].[AcademicPerformanceCharterSchools]\n    ),\n    cte_district_agg AS (\n        SELECT  \n              [SchoolYear]\n            , [StudentGroupType]\n            , [StudentGroupCategory]\n            , [StudentGroup]\n            , [GradeLevel]\n            , [TestAdministration]\n            , [TestSubject]\n            , AVG([PercentMet District]) AS [PercentMetStandard District]\n            , SUM([CountMetStandard District]) AS [CountMetStandard District]\n            , SUM([CountofStudentsExpectedtoTest(including previously passed) District]) AS [CountofStudentsExpectedtoTest(including previously passed) District]\n            , CAST(SUM([CountMetStandard District]) AS FLOAT) /\n               NULLIF(SUM([CountofStudentsExpectedtoTest(including previously passed) District]),0) AS [PercentMet District]\n        FROM cte_district\n        GROUP BY \n              [SchoolYear], [StudentGroupType], [StudentGroupCategory], [StudentGroup],\n              [GradeLevel], [TestAdministration], [TestSubject]\n    ),\n    cte_school AS (\n        SELECT  \n              [SchoolYear]\n            , [StudentGroupType]\n            , [StudentGroupCategory]\n            , [StudentGroup]\n            , [GradeLevel]\n            , [TestAdministration]\n            , [TestSubject]\n            , AVG([PercentMetSchool]) AS [PercentMet School]\n            , SUM([CountMetStandard School]) AS [CountMetStandard School]\n            , SUM([CountofStudentsExpectedtoTest(including previously passed) School]) AS [CountofStudentsExpectedtoTest(including previously passed) School]\n            , CAST(SUM([CountMetStandard School]) AS FLOAT) \n              / NULLIF(SUM([CountofStudentsExpectedtoTest(including previously passed) School]),0)  \n              AS [PercentMetSchool]\n        FROM [scorecard].[AcademicPerformanceCharterSchools] a\n        WHERE a.[SchoolName] LIKE '%Sector%'\n        GROUP BY \n              [SchoolYear], [StudentGroupType], [StudentGroupCategory], [StudentGroup],\n              [GradeLevel], [TestAdministration], [TestSubject]\n    )\n    SELECT  \n          a.[SchoolYear]\n        , 'Charter Sector' AS [OrganizationLevel]\n        , a.[StudentGroupType]\n        , a.[StudentGroupCategory]\n        , a.[StudentGroup]\n        , a.[GradeLevel]\n        , a.[TestAdministration]\n        , a.[TestSubject]\n        , [CountMetStandard School]\n        , [CountofStudentsExpectedtoTest(including previously passed) School]\n        , [PercentMetSchool]\n        , [CountMetStandard District]\n        , [CountofStudentsExpectedtoTest(including previously passed) District]\n        , [PercentMet District]\n        , [CountMetStandard State]\n        , [CountofStudentsExpectedtoTest(including previously passed) State]\n        , [PercentMetStandard State]\n        , [PercentMet State]\n    FROM cte_school a\n    JOIN cte_district_agg b \n        ON  a.SchoolYear       = b.SchoolYear\n        AND a.StudentGroup     = b.StudentGroup\n        AND a.GradeLevel       = b.GradeLevel\n        AND a.TestAdministration = b.TestAdministration\n        AND a.TestSubject      = b.TestSubject\n    JOIN [transform].[AcademicPerformanceState] s \n        ON  a.SchoolYear       = s.SchoolYear \n        AND a.StudentGroup     = s.StudentGroup\n        AND a.GradeLevel       = s.GradeLevel\n        AND a.TestAdministration = s.TestAdministration\n        AND a.TestSubject      = s.TestSubject;\nEND\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "GatesDedicatedSql",
				"poolName": "GatesDedicatedSql"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}