{
	"name": "Scorecard AP Charter Schools",
	"properties": {
		"content": {
			"query": "SET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE PROC [scorecard].[sp_AcademicPerformanceCharterSchools_MOD] AS\nBEGIN\n    SET NOCOUNT ON;\n\n    ------------------------------------------------------------\n    -- Safe drop if table exists\n    ------------------------------------------------------------\n    IF OBJECT_ID('scorecard.AcademicPerformanceCharterSchools', 'U') IS NOT NULL\n    BEGIN\n        DROP TABLE scorecard.AcademicPerformanceCharterSchools;\n    END;\n\n    ------------------------------------------------------------\n    -- CTAS with HEAP to avoid columnstore issues\n    ------------------------------------------------------------\n    CREATE TABLE [scorecard].[AcademicPerformanceCharterSchools]\n    WITH\n    (\n        DISTRIBUTION = ROUND_ROBIN,\n        HEAP\n    )\n    AS\n    WITH Cte_school AS (\n        SELECT DISTINCT \n              [SchoolYear]\n            , [StudentGroupType]\n            , [StudentGroupCategory]\n            , [StudentGroup]\n            , [GradeLevel]\n            , [TestAdministration]\n            , [TestSubject]\n            , SUM([CountMetStandard School]) AS [CountMetStandard School]\n            , SUM([CountofStudentsExpectedtoTest(including previously passed) School]) AS [CountofStudentsExpectedtoTest(including previously passed) School]\n            , CAST(SUM([CountMetStandard School]) AS FLOAT) \n              / NULLIF(SUM([CountofStudentsExpectedtoTest(including previously passed) School]),0) AS [PercentMet School]\n        FROM [transform].[AcademicPerformanceSchool]\n        WHERE [Charter School] = 'Yes'\n        GROUP BY \n              [SchoolYear], [StudentGroupType], [StudentGroupCategory],\n              [StudentGroup], [GradeLevel], [TestAdministration], [TestSubject]\n    ),\n    Cte_district AS (\n        SELECT DISTINCT \n              [SchoolYear]\n            , [StudentGroupType]\n            , [StudentGroupCategory]\n            , [StudentGroup]\n            , [GradeLevel]\n            , [TestAdministration]\n            , [TestSubject]\n            , SUM([CountMetStandard District]) AS [CountMetStandard District]\n            , SUM([CountofStudentsExpectedtoTest(including previously passed) District]) AS [CountofStudentsExpectedtoTest(including previously passed) District]\n            , CAST(SUM([CountMetStandard District]) AS FLOAT) \n              / NULLIF(SUM([CountofStudentsExpectedtoTest(including previously passed) District]),0) AS [PercentMet District] \n        FROM [scorecard].[AcademicPerformanceCharterDistrict] s\n        WHERE [Charter District] = 'Yes'\n        GROUP BY \n              [SchoolYear], [StudentGroupType], [StudentGroupCategory],\n              [StudentGroup], [GradeLevel], [TestAdministration], [TestSubject]\n    )\n    SELECT \n          a.[SchoolYear]\n        , a.[SchoolCode]\n        , a.[SchoolName]\n        , b.[DistrictCode]\n        , b.[DistrictName]\n        , a.[StudentGroupType]\n        , a.[StudentGroupCategory]\n        , a.[StudentGroup]\n        , a.[GradeLevel]\n        , a.[TestAdministration]\n        , a.[TestSubject]\n        , [CountMetStandard School]\n        , [CountofStudentsExpectedtoTest(including previously passed) School]\n        , [PercentMetSchool]\n        , [CountMetStandard District]\n        , [CountofStudentsExpectedtoTest(including previously passed) District]\n        , [PercentMet District]\n    FROM [transform].[AcademicPerformanceSchool] a\n    JOIN [scorecard].[AcademicPerformanceCharterDistrict] b \n        ON  a.DistrictCode = b.DistrictCode \n        AND a.SchoolYear   = b.SchoolYear \n        AND a.StudentGroup = b.StudentGroup \n        AND a.GradeLevel   = b.GradeLevel \n        AND a.TestAdministration = b.TestAdministration\n        AND a.TestSubject  = b.TestSubject\n    WHERE [Charter School] = 'Yes'\n\n    UNION\n\n    SELECT DISTINCT \n          s.[SchoolYear]\n        , '0000'   AS [SchoolCode]\n        , 'Charter Sector' AS [SchoolName]\n        , '00000'  AS [DistrictCode]\n        , 'Charter Sector District' AS [DistrictName]\n        , s.[StudentGroupType]\n        , s.[StudentGroupCategory]\n        , s.[StudentGroup]\n        , s.[GradeLevel]\n        , s.[TestAdministration]\n        , s.[TestSubject]\n        , [CountMetStandard School]\n        , [CountofStudentsExpectedtoTest(including previously passed) School]\n        , [PercentMet School]\n        , [CountMetStandard District]\n        , [CountofStudentsExpectedtoTest(including previously passed) District]\n        , [PercentMet District]\n    FROM Cte_school s\n    JOIN Cte_district d \n        ON  s.SchoolYear       = d.SchoolYear\n        AND s.StudentGroup     = d.StudentGroup \n        AND s.GradeLevel       = d.GradeLevel \n        AND s.TestAdministration = d.TestAdministration\n        AND s.TestSubject      = d.TestSubject;\nEND\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "GatesDedicatedSql",
				"poolName": "GatesDedicatedSql"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}